# --- ç¬¬ä¸€éƒ¨åˆ†ï¼šå®šä¹‰ Deployment (åº”ç”¨æœ¬èº«) ---
# apiVersion: æŒ‡å®šä½¿ç”¨çš„ Kubernetes API ç‰ˆæœ¬ï¼Œapps/v1 æ˜¯ç”¨äºå·¥ä½œè´Ÿè½½èµ„æºçš„æ ‡å‡†ç‰ˆæœ¬
apiVersion: apps/v1
# kind: å®šä¹‰èµ„æºç±»å‹ï¼Œåœ¨è¿™é‡Œæ˜¯ Deploymentï¼Œç”¨äºç®¡ç† Pod çš„å‰¯æœ¬å’Œæ›´æ–°ç­–ç•¥
kind: Deployment
# metadata: åŒ…å«èµ„æºçš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚åç§°ã€æ ‡ç­¾ç­‰
metadata:
    # name: Deployment çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåœ¨é›†ç¾¤ä¸­è¯†åˆ«æ­¤éƒ¨ç½²
    name: nginx-proxy
# spec: å®šä¹‰èµ„æºçš„æœŸæœ›çŠ¶æ€å’Œé…ç½®ç»†èŠ‚
spec:
    # replicas: æŒ‡å®šæœŸæœ›è¿è¡Œçš„ Pod å‰¯æœ¬æ•°é‡
    replicas: 1
    # selector: å®šä¹‰å¦‚ä½•é€‰æ‹©è¦ç®¡ç†çš„ Pod
    selector:
        # matchLabels: é€šè¿‡æ ‡ç­¾åŒ¹é…è¦ç®¡ç†çš„ Pod
        matchLabels:
            # app: nginx-proxy: é€‰æ‹©å¸¦æœ‰ app=nginx-proxy æ ‡ç­¾çš„ Pod
            app: nginx-proxy
    # template: å®šä¹‰ Pod æ¨¡æ¿ï¼Œæè¿°å¦‚ä½•åˆ›å»º Pod
    template:
        # metadata: Pod çš„å…ƒæ•°æ®
        metadata:
            # labels: ä¸º Pod åˆ†é…æ ‡ç­¾ï¼Œä½¿ Deployment èƒ½å¤Ÿè¯†åˆ«å’Œç®¡ç†è¿™äº› Pod
            labels:
                # app: nginx-proxy: ç»™ Pod æ‰“ä¸Š app=nginx-proxy æ ‡ç­¾
                app: nginx-proxy
        # spec: Pod è§„èŒƒï¼Œå®šä¹‰ Pod çš„å…·ä½“é…ç½®
        spec:
            # containers: å®šä¹‰ Pod ä¸­è¿è¡Œçš„å®¹å™¨åˆ—è¡¨
            containers:
                # - name: å®¹å™¨åç§°
                - name: nginx
                  # image: æŒ‡å®šè¦ä½¿ç”¨çš„ Docker é•œåƒåŠç‰ˆæœ¬
                  image: nginx:latest
                  # ports: å®šä¹‰å®¹å™¨æš´éœ²çš„ç«¯å£
                  ports:
                      # - containerPort: å®¹å™¨å†…ç›‘å¬çš„ç«¯å£å·
                      - containerPort: 80
                  # resources: å®šä¹‰å®¹å™¨çš„èµ„æºè¯·æ±‚å’Œé™åˆ¶
                  resources:
                      # requests: å®¹å™¨å¯åŠ¨æ—¶ä¿è¯åˆ†é…çš„æœ€å°èµ„æºé‡
                      requests:
                          # memory: æœ€å°‘éœ€è¦åˆ†é…çš„å†…å­˜
                          memory: "64Mi"
                          # cpu: æœ€å°‘éœ€è¦åˆ†é…çš„ CPU èµ„æº
                          cpu: "250m"
                      # limits: å®¹å™¨å¯ä»¥ä½¿ç”¨çš„æœ€å¤§èµ„æºé‡
                      limits:
                          # memory: æœ€å¤§å¯ä»¥ä½¿ç”¨çš„å†…å­˜
                          memory: "128Mi"
                          # cpu: æœ€å¤§å¯ä»¥ä½¿ç”¨çš„ CPU èµ„æº
                          cpu: "500m"
                  # volumeMounts: å®šä¹‰å·æŒ‚è½½ç‚¹ï¼Œå°†å­˜å‚¨å·æ˜ å°„åˆ°å®¹å™¨å†…çš„è·¯å¾„
                  volumeMounts:
                      # - name: å¼•ç”¨åœ¨ volumes éƒ¨åˆ†å®šä¹‰çš„å·å
                      - name: config-volume
                        # mountPath: å®¹å™¨å†…æŒ‚è½½å·çš„è·¯å¾„
                        mountPath: /etc/nginx/nginx.conf
                        # subPath: æŒ‚è½½å·ä¸­çš„ç‰¹å®šæ–‡ä»¶æˆ–å­ç›®å½•ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå·
                        subPath: nginx.conf # åªæŒ‚è½½è¿™å°±ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸è¦†ç›–æ•´ä¸ªç›®å½•
            # volumes: å®šä¹‰ Pod çº§åˆ«çš„å­˜å‚¨å·
            volumes:
                # - name: å·çš„åç§°ï¼Œä¾› volumeMounts å¼•ç”¨
                - name: config-volume
                  # configMap: å°† ConfigMap æ•°æ®ä½œä¸ºå·æä¾›ç»™å®¹å™¨
                  configMap:
                      # name: å¼•ç”¨å·²å­˜åœ¨çš„ ConfigMap åç§°
                      name: nginx-conf # ğŸ‘ˆ å¼•ç”¨åˆšæ‰åˆ›å»ºçš„ ConfigMap
---
# --- ç¬¬äºŒéƒ¨åˆ†ï¼šå®šä¹‰ Service (ç½‘ç»œå…¥å£) ---
# apiVersion: ä½¿ç”¨æ ¸å¿ƒ v1 API ç‰ˆæœ¬æ¥å®šä¹‰ Service èµ„æº
apiVersion: v1
# kind: å®šä¹‰èµ„æºç±»å‹ä¸º Serviceï¼Œæä¾›ç½‘ç»œè®¿é—®å…¥å£
kind: Service
# metadata: Service çš„å…ƒæ•°æ®
metadata:
    # name: Service çš„åç§°ï¼Œå…¶ä»–æœåŠ¡å¯ä»¥é€šè¿‡è¿™ä¸ªåå­—å‘ç°æ­¤æœåŠ¡
    name: nginx-svc # æœåŠ¡åå­—
# spec: Service çš„è§„æ ¼è¯´æ˜
spec:
    # type: å®šä¹‰æœåŠ¡æš´éœ²æ–¹å¼ï¼ŒLoadBalancer åœ¨äº‘ç¯å¢ƒä¸­åˆ›å»ºå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨
    type: LoadBalancer # ç±»å‹ï¼šLoadBalancer (Docker Desktop ä¼šè‡ªåŠ¨æŠŠè¿™ä¸ªæš´éœ²åˆ° localhost)
    # selector: é€šè¿‡æ ‡ç­¾é€‰æ‹©åç«¯ Pod
    selector:
        # app: my-nginx: é€‰æ‹©å¸¦æœ‰ app=my-nginx æ ‡ç­¾çš„ Podï¼ˆæ³¨æ„ï¼šè¿™é‡Œåº”è¯¥ä¸ deployment ä¸­çš„æ ‡ç­¾ä¸€è‡´ï¼‰
        app: nginx-proxy # é‡ç‚¹ï¼šé€šè¿‡æ ‡ç­¾æ‰¾åˆ°ä¸Šé¢çš„ Deployment
    # ports: å®šä¹‰æœåŠ¡æš´éœ²çš„ç«¯å£
    ports:
        # - protocol: ç«¯å£ä½¿ç”¨çš„åè®®
        - protocol: TCP
          # port: æœåŠ¡å¯¹å¤–æš´éœ²çš„ç«¯å£å·ï¼Œå…¶ä»–æœåŠ¡é€šè¿‡æ­¤ç«¯å£è®¿é—®æœåŠ¡
          port: 8032 # å¤–éƒ¨è®¿é—®ç«¯å£
          # targetPort: æœåŠ¡è½¬å‘æµé‡åˆ°åç«¯ Pod çš„ç«¯å£å·
          targetPort: 80 # å®¹å™¨å†…éƒ¨ç«¯å£
