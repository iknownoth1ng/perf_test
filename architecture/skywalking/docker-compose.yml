version: "3.8"
services:
    # 1. SkyWalking OAP 后端
    oap:
        image: apache/skywalking-oap-server:9.5.0
        container_name: skywalking-oap
        restart: always
        ports:
            - "11800:11800" # Agent 上报数据的端口 (gRPC)
            - "12800:12800" # UI 查询数据的端口 (HTTP)
        environment:
            SW_STORAGE: h2 # 学习环境用 H2 内存数据库，生产环境通常用 Elasticsearch
            SW_HEALTH_CHECKER: default
            SW_TELEMETRY: prometheus
            TZ: Asia/Shanghai # ✅ 强制设置为上海时间
        healthcheck:
            test: ["CMD-SHELL", "/skywalking/bin/swctl ch"]
            interval: 30s
            timeout: 10s
            retries: 3
        networks:
            - global-monitor-net # 加入公共网络，方便以后和其他容器通信

    # 2. SkyWalking UI 前端
    ui:
        image: apache/skywalking-ui:9.5.0
        container_name: skywalking-ui
        restart: always
        ports:
            - "8088:8080" # 外部访问端口改到 8088，防止冲突
        environment:
            SW_OAP_ADDRESS: http://oap:12800 # 指向 OAP 服务
            TZ: Asia/Shanghai # ✅ 强制设置为上海时间
        depends_on:
            oap:
                condition: service_healthy
        networks:
            - global-monitor-net

networks:
    global-monitor-net:
        external: true
